<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Best√§llning - √Ñt.se</title>
  <link rel="stylesheet" href="kundvagn.css" />
  <link rel="icon" type="image/x-icon" href="../images/image-removebg-preview.png">
</head>
<body>
  <!-- huvuddel med logga in, om oss, inloggning, tillbaka och kundvagn -->
  <header>
    <div class="header">
        <div class="leftsection">
            <div class="logoclick">
                <a href="index.html"><img src="../images/image-removebg-preview.png" alt="logo" class="logo"></a>
                <a href="index.html" style="text-decoration: none"><span class="site">√Ñt.se</span></a>
            </div>
        <a href="omoss.html"><button class="omoss">Om oss</button></a>
        </div>
        <div class="logincart">
            <a href="login.html"><button class="login">Logga In</button></a>
            <a href="register.html"><button class="register">Registrera</button></a>
            <button id="logoutBtn" style="display:none;">Logga ut</button>
            <a href="kundvagn.html"><img src="../images/basket-cart-icon-27.png" alt="cart" class="cart-icon"></a>
        </div>
    </div>
  </header>

  <main>
    <h2>Din best√§llning</h2>
<!-- kommer visa datum och tiden h√§r -->
    <div id="dateTimeWrapper"></div>




    <!-- formul√§r f√∂r kunduppgifter och betalning -->
    <form id="orderForm" class="form" action="/submit-order" method="POST">
      <!-- f√§lt f√∂r namn -->
      <div class="name-fields">
        <input type="text" id="first_name" name="first_name" placeholder="F√∂rnamn" required />
        <input type="text" id="last_name" name="last_name" placeholder="Efternamn" required >
      </div>
      <!-- telefonnummer med landskod -->
      <div class="phone-field">
        <img src="https://flagcdn.com/w40/se.png" width="30" class="me-2" alt="Swedish flag"> 
        <input type="tel"id="phone_number" name="phone_number" placeholder="Telefonnummer" required />
      </div>

      <!-- f√§lt f√∂r email -->
      <input type="email" id="email" name="email" required placeholder="E-post" class="email" />
      

      <div id="totalPriceWrapper" style="text-align: center; font-size: 18px; font-weight: bold; margin-top: 20px;"></div>
      <!-- val av betalningsmetod -->
      <div class="payment-section">
        <label><input type="radio" name="payment" /> Kortbetalning (Visa, Mastercard)</label>
        <label><input type="radio" name="payment" /> Swish</label>
        <label><input type="radio" name="payment" /> Klarna</label>
      </div>
      <button type="submit" class="submit-btn" onclick="submitOrder(event)">Slutf√∂r best√§llning</button>
    </form>
  </main>

  <script src="loginLogik.js"></script>

  <script>
//sparar mejlen som finns p√• localstorage
  const savedEmail = localStorage.getItem("email");
  if (savedEmail) {
    document.getElementById("email").value = savedEmail;
  }
//spara kund vagn varor
const cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];
//funktion som anv√§nder json och anv√§dnder strinify p√• cartItems variabeln
function saveCartItems() {
    localStorage.setItem("cartItems", JSON.stringify(cartItems));
}
//renderCart funktion
function renderCart() {
    //sparar, main f√∂r main html egenskap
    const main = document.querySelector("main");
    //sparar form f√∂r form html egenskap
    const form = main.querySelector("form");

    //existerande boxes (matr√§tten, antal, pris osv kommer visas h√§r)
    const existingBoxes = main.querySelectorAll(".order-box");
    existingBoxes.forEach(box => box.remove());

    //om det finns mer √§n 0 varor (1 eller h√∂gre)
    if (cartItems.length > 0) {
        //f√∂r varje vara: (tar in index och item arguement)
        cartItems.forEach((item, index) => {
            //spara orderBox (och det √§r barje div) (skapa div)
            const orderBox = document.createElement("div");
            //addera det (f√∂r classlist)
            orderBox.classList.add("order-box");
            //image, (img) alt om image src finns inte och skapa image
            const img = document.createElement("img");
            img.src = item.img || 'default.jpg';
            img.alt = item.name;
            //skapar div f√∂r orderInfo
            const orderInfo = document.createElement("div");
            //addera ocks√• f√∂r classlist
            orderInfo.classList.add("order-info");
            //styling f√∂r att snygga till, padding fr√•n v√§nster och det √§r 20px
            orderInfo.style.paddingLeft = "20px"; 
            //strong = bold. skapa old
            const strong = document.createElement("strong");
            //item name √§r strong 
            strong.textContent = item.name;
            //skapar pris parameter
            const pricePara = document.createElement("p");
            //visa det som : Pris: x kr osv
            pricePara.textContent = "Pris: " + item.price +"kr";
            //skapar quantitet.
            const quantityPara = document.createElement("p");
            quantityPara.textContent = "Antal:";
            //papperskorg, minus knapp pluss knapp
            const quantityControls = document.createElement("adiv");
            quantityControls.classList.add("quantity-controls");
            //f√∂r att minska (med ett f√∂r knapen)
            const minusBtn = document.createElement("button");
            //minus knappen -
            minusBtn.textContent = "-";
            //minska med ett. f√∂r varje g√•ng man tryker p√• -.
            minusBtn.onclick = () => {
                if (item.quantity > 1) {
                    item.quantity--;
                } else {
                    cartItems.splice(index, 1); 
                }
                //anrop funktioner efter √§ndringar
                saveCartItems();
                renderCart();
            };
        
            const quantitySpan = document.createElement("span");
            //visa antalet av varan:
            quantitySpan.textContent = item.quantity;
            quantitySpan.style.margin = "0 10px";
            //skapar + knapp nu, √∂ka med 1
            const plusBtn = document.createElement("button");
            plusBtn.textContent = "+";
            plusBtn.onclick = () => {
                item.quantity++;
                //anrop savecartitems och render cart funktioner
                saveCartItems();
                renderCart();
            };
            //skapa pappersskorg knappen
            const trashBtn = document.createElement("button");
            trashBtn.textContent = "üóëÔ∏è";
            trashBtn.style.marginLeft = "15px";
            //ta bort varan. g√∂r det h√§r med      cartItems.splice(index, 1);.
            trashBtn.onclick = () => {
                cartItems.splice(index, 1);
                //anrop funktioner d√•
                saveCartItems();
                renderCart();
            };
            //quantity controls visar - x + och papperskorgen f√∂r att ta bort. x √§r antalet av ett vara
            quantityControls.append(minusBtn, quantitySpan, plusBtn, trashBtn);
            //visa priset, namnet av varan quanititet och -,+ och papperskorg
            orderInfo.append(strong, pricePara, quantityPara, quantityControls);
            //visa bilden ocks√• med orderInfo
            orderBox.append(img, orderInfo);
            //allt det h√§r kommer innan form d√• (f√∂rnamn, efternamn osv)
            main.insertBefore(orderBox, form);
        });
        //visa totalt pris 
        displayTotalPrice();
    } else {
        //skapar ett wrapper.
        const wrapper = document.createElement("div");
        wrapper.style.backgroundColor = "white";
        wrapper.style.padding = "20px";
        wrapper.style.marginBottom = "20px";
        wrapper.style.borderRadius = "10px";
        wrapper.style.width = "20%";
        wrapper.style.margin = "20px auto";
        wrapper.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.1)";
        wrapper.style.textAlign = "center";
        //om kundvagn har inget i sig visa att kundvagn √§r helt tom.
        const emptyMessage = document.createElement("p");
        emptyMessage.textContent = "Kundvagn √§r tom.";
        emptyMessage.style.fontSize = "30px";
        emptyMessage.style.margin = "0";
        //och innan form d√•.
        wrapper.appendChild(emptyMessage);
        const form = document.querySelector("form");
        form.parentNode.insertBefore(wrapper, form);
        //total price wrapper 0kr om man har inte lagt till n√•got
        const totalPriceWrapper = document.getElementById("totalPriceWrapper");
        totalPriceWrapper.textContent = "Totalt pris: 0kr";
    }
}
//total pris funktion
function displayTotalPrice() {
    const totalPriceWrapper = document.getElementById("totalPriceWrapper");
    //totalt fr√•n b√∂rjan √§r 0kr
    let total = 0;
    //f√∂r varje item, matte logiken under k√∂rs (totalt pris √§r bara (ny varan *antal st) + summan  )
    cartItems.forEach(item => {
        const price = parseFloat(item.price);
        const quantity = parseInt(item.quantity);
        if (!isNaN(price) && !isNaN(quantity)) {
            total += price * quantity;
        }
    });
    //visa det p√• sk√§rmen
    totalPriceWrapper.textContent = "Totalt Pris: " + total.toFixed(2) + " SEK";
}

//anropa rendercart
renderCart();
//date time funktionen
function updateDateTime() {
    const now = new Date();
    //anv√§ndar Se format(tme)
    const formatted = now.toLocaleString('sv-SE', {
        year: 'numeric',
        //tar 2 h√§nsyn till 2 digit
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    //spara dateTimewrapper som dateDiv
    const dateDiv = document.getElementById("dateTimeWrapper");
    //visa p√• sk√§rmen
    dateDiv.textContent = "Datum & tid: " + formatted;
    //css f√∂r att snygga till
    dateDiv.style.backgroundColor = "white";
    dateDiv.style.padding = "10px";
    dateDiv.style.margin = "20px auto";
    dateDiv.style.width = "20%"
    dateDiv.style.textAlign = "center";
    dateDiv.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.1)";
    dateDiv.style.borderRadius = "10px";
}
//dubbel kollar s√• man skickar inte en tom korg
let isSubmitting = false;

async function submitOrder(event) {
//f√∂rhindra skickandet av ett tom mejl.
  event.preventDefault();
  if (isSubmitting) return;
  isSubmitting = true;
 //user id √§r alltid 1. user id har inte haft betydlese f√∂r √§t.se kedjan
  const user_id = 1;
  //spara olika variabller
  const cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];
  const first_name = document.getElementById("first_name").value;
  const last_name = document.getElementById("last_name").value;
  const phone_number = document.getElementById("phone_number").value;
  const email = document.getElementById("email").value;
  //spara orderDate
  const orderDate = new Date().toLocaleString('sv-SE', {
  year: 'numeric',
  month: '2-digit',
  day: '2-digit',
  hour: '2-digit',
  minute: '2-digit',
  second: '2-digit'
});
  //response fetchar submit order med method post
  const response = await fetch("/submit-order", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    //skickar f√∂ljande variabler som sen kommer hanteras
    body: JSON.stringify({
      user_id,
      cartItems,
      first_name,
      last_name,
      phone_number,
      email,
      orderDate
    })
  });
  //om respone √§r ok (godk√§nt)
  if (response.ok) {
    //ta bort alla matr√§tter fr√•n kundvagn
    localStorage.removeItem("cartItems");
    //sen redirekt till confirmation sidan
    window.location.href = "/confirmation";
  } else { //annars var n√•got felaktigt. l√•t anv√§ndaren veta det
    alert("Fel vid skickande av best√§llning");
    isSubmitting = false;  
  }
}


updateDateTime();
setInterval(updateDateTime, 1000);

</script>
  
</body>
</html>